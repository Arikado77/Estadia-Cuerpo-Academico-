<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="CA.css">
    <link rel="stylesheet" href="Noticias.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <title>Noticias - CA-TICO</title>
</head>
<body>

    <nav>
        <div class="brand">
            <img src="img/Gemini_Generated_Image_6fk5kt6fk5kt6fk5.png" alt="Logo">
            <a href="index.html" class="logo">Cuerpo Acad√©mico</a>
        </div>
        <div class="links">
            <a href="index.html">Inicio</a>
            <a href="CA.html">¬øQu√© es CA?</a>
            <a href="Conocimiento.html">L√≠neas de Conocimiento</a>
            <a href="Noticias.html">Noticias y mas</a>
            <a href="Sitios.html">Proyectos</a>
        </div>
        <div class="nav-bar">
            <div id="auth-link">
                <a href="login.html" class="login-button">Iniciar Sesi√≥n</a>
            </div>
        </div>
    </nav>

    <div id="admin-panel" style="display:none;">
        <hr>
        <h2>Panel de Administraci√≥n</h2>
        <div class="admin-controls">
            <button class="admin-button add-button" onclick="openModal()">‚ûï Agregar Noticia</button>
        </div>
        <hr>
    </div>

    <main class="noticias-main">
        <div class="noticias-container">
            
            <section class="social-qr-section">
                <h2>S√≠guenos en Redes Sociales</h2>
                <p>Escanea los c√≥digos QR o da click en la palabra para acceder a nuestras √∫ltimas novedades.</p>
                <div class="qr-grid">
                    <div class="qr-item">
                        <img src="img/Facebook-QR.jpg" alt="QR Facebook" class="qr-code">
                        <a href="https://www.facebook.com/share/..." target="_blank" class="qr-link">Facebook</a>
                    </div>
                    <div class="qr-item">
                        <img src="img/Instagram-QR.jpg" alt="QR Instagram" class="qr-code">
                        <a href="https://www.instagram.com/..." target="_blank" class="qr-link">Instagram</a>
                    </div>
                </div>
            </section>

            <section class="noticias-section">
                <h2>Noticias Recientes desde la Web</h2>
                <div id="contenedor-noticias">
                    <p style="text-align:center;">Cargando noticias...</p>
                </div>
            </section>
        </div>
    </main>

    <div id="modal-noticia" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modal-titulo">Nueva Noticia</h3>
            <form id="form-noticia">
                <input type="hidden" id="noticia-id">
                
                <input type="text" id="noticia-titulo" placeholder="T√≠tulo de la noticia" required>
                <textarea id="noticia-contenido" placeholder="Descripci√≥n de la noticia" rows="5" required></textarea>
                
                <div class="file-select-container" style="margin: 15px 0; text-align: center;">
                    <label for="noticia-imagen" class="admin-button" style="cursor: pointer; background-color: #f0f2f5; color: #333; border: 1px dashed #004d80;">
                        <i class='bx bx-image-add'></i> Seleccionar Imagen de Galer√≠a
                    </label>
                    <input type="file" id="noticia-imagen" accept="image/*" style="display: none;">
                    <p id="file-name" style="font-size: 0.8em; color: #666; margin-top: 5px;"></p>
                </div>

                <button type="submit" id="btn-submit-noticia" class="admin-button">Publicar Noticia</button>
            </form>
        </div>
    </div>

    <script src="VerBotonPerfil.js"></script>
    <script>
        // --- FUNCIONES DEL MODAL ---
        function openModal() { 
            document.getElementById('modal-noticia').style.display = 'block'; 
        }

        function closeModal() { 
            document.getElementById('modal-noticia').style.display = 'none';
            document.getElementById('form-noticia').reset();
            document.getElementById('noticia-id').value = '';
            document.getElementById('modal-titulo').textContent = "Nueva Noticia";
            document.getElementById('btn-submit-noticia').textContent = "Publicar Noticia";
            document.getElementById('file-name').textContent = "";
        }

        // Funci√≥n para cargar datos y EDITAR
        function prepararEdicion(id, titulo, contenido) {
            document.getElementById('modal-titulo').textContent = "Editar Noticia";
            document.getElementById('noticia-id').value = id;
            document.getElementById('noticia-titulo').value = titulo;
            document.getElementById('noticia-contenido').value = contenido;
            document.getElementById('btn-submit-noticia').textContent = "Actualizar Noticia";
            openModal();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const contenedor = document.getElementById('contenedor-noticias');
            const adminPanel = document.getElementById('admin-panel');

            // 1. Verificar sesi√≥n y rango
            const resUser = await fetch('/api/usuario/perfil');
            const userData = await resUser.json();
            const isAdmin = userData.success && userData.user.es_admin === true;

            if (isAdmin) adminPanel.style.display = 'block';

            // Mostrar nombre del archivo al seleccionarlo
            const fileInput = document.getElementById('noticia-imagen');
            fileInput.onchange = function() {
                if (this.files[0]) {
                    document.getElementById('file-name').textContent = "Archivo: " + this.files[0].name;
                }
            };

            // 2. Cargar Noticias
            async function cargarNoticias() {
                const res = await fetch('/api/noticias');
                const data = await res.json();
                
                if (data.success) {
                    contenedor.innerHTML = '';
                    if(data.noticias.length === 0) {
                        contenedor.innerHTML = '<p style="text-align:center;">No hay noticias que mostrar.</p>';
                        return;
                    }
                    data.noticias.forEach(n => {
                        const div = document.createElement('div');
                        div.className = 'noticia-item';
                        div.style.position = "relative";
                        div.innerHTML = `
                            ${isAdmin ? `
                                <div class="edit-buttons" style="position: absolute; top: 10px; right: 10px;">
                                    <button class="edit-button" onclick="prepararEdicion(${n.id}, \`${n.titulo}\`, \`${n.contenido}\`)">‚úèÔ∏è</button>
                                    <button class="delete-button" onclick="eliminarNoticia(${n.id})">üóëÔ∏è</button>
                                </div>
                            ` : ''}
                            ${n.imagen_url ? `<img src="${n.imagen_url}" style="width:100%; border-radius:8px; margin-bottom:15px; max-height:400px; object-fit:cover;">` : ''}
                            <h3>${n.titulo}</h3>
                            <p>${n.contenido}</p>
                            <div style="margin-top:10px; font-size:0.8em; color:#888;">
                                <span><i class='bx bx-calendar'></i> ${new Date(n.fecha_creacion).toLocaleDateString()}</span>
                                <span style="margin-left:15px;"><i class='bx bx-user'></i> ${n.autor || 'Sistema'}</span>
                            </div>
                        `;
                        contenedor.appendChild(div);
                    });
                }
            }

            cargarNoticias();

            // 3. Manejo del Formulario (Crear/Editar)
            document.getElementById('form-noticia').onsubmit = async (e) => {
                e.preventDefault();
                
                const formData = new FormData();
                formData.append('id', document.getElementById('noticia-id').value);
                formData.append('titulo', document.getElementById('noticia-titulo').value);
                formData.append('contenido', document.getElementById('noticia-contenido').value);
                
                const foto = document.getElementById('noticia-imagen').files[0];
                if (foto) {
                    formData.append('imagen', foto);
                }

                const res = await fetch('/api/noticias', {
                    method: 'POST',
                    body: formData 
                });

                if (res.ok) {
                    alert("¬°Operaci√≥n exitosa!");
                    closeModal();
                    location.reload();
                } else {
                    alert("Error al procesar la noticia. Verifica que el archivo no sea demasiado pesado.");
                }
            };
        });

        async function eliminarNoticia(id) {
            if(confirm("¬øSeguro que quieres borrar esta noticia?")) {
                const res = await fetch(`/api/noticias/${id}`, { method: 'DELETE' });
                if(res.ok) location.reload();
            }
        }
    </script>

    <style>
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 10px; width: 50%; position: relative; }
        .modal-content input, .modal-content textarea { width: 100%; margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .close { position: absolute; top: 10px; right: 20px; font-size: 30px; cursor: pointer; }
        .noticia-item { border: 1px solid #ddd; padding: 20px; border-radius: 10px; margin-bottom: 20px; background: #fff; }
        .edit-button, .delete-button { cursor: pointer; border: none; background: #eee; padding: 5px 10px; border-radius: 5px; margin-left: 5px; }
        .edit-button:hover { background: #ffc107; }
        .delete-button:hover { background: #dc3545; color: white; }
    </style>
</body>
</html>