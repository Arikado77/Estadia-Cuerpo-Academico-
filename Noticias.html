<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="CA.css">
    <link rel="stylesheet" href="Noticias.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <title>Noticias - CA-TICO</title>
</head>
<body>

    <nav>
        <div class="brand">
            <img src="img/Gemini_Generated_Image_6fk5kt6fk5kt6fk5.png" alt="Logo">
            <a href="index.html" class="logo">Cuerpo Acad√©mico</a>
        </div>
        <div class="links">
            <a href="index.html">Inicio</a>
            <a href="CA.html">¬øQu√© es CA?</a>
            <a href="Conocimiento.html">L√≠neas de Conocimiento</a>
            <a href="Noticias.html">Noticias y mas</a>
            <a href="Sitios.html">Proyectos</a>
        </div>
        <div class="nav-bar">
            <div id="auth-link">
                <a href="login.html" class="login-button">Iniciar Sesi√≥n</a>
            </div>
        </div>
    </nav>

    <div id="admin-panel" style="display:none;">
        <hr>
        <h2>Panel de Administraci√≥n</h2>
        <div class="admin-controls">
            <button class="admin-button add-button" onclick="openModal()">‚ûï Agregar Noticia</button>
        </div>
        <hr>
    </div>

    <main class="noticias-main">
        <div class="noticias-container">
            
            <section class="social-qr-section">
                <h2>S√≠guenos en Redes Sociales</h2>
                <p>Escanea los c√≥digos QR o da click en la palabra para acceder a nuestras √∫ltimas novedades.</p>
                <div class="qr-grid">
                    <div class="qr-item">
                        <img src="img/Facebook-QR.jpg" alt="QR Facebook" class="qr-code">
                        <a href="https://www.facebook.com/share/..." target="_blank" class="qr-link">Facebook</a>
                    </div>
                    <div class="qr-item">
                        <img src="img/Instagram-QR.jpg" alt="QR Instagram" class="qr-code">
                        <a href="https://www.instagram.com/..." target="_blank" class="qr-link">Instagram</a>
                    </div>
                </div>
            </section>

            <section class="noticias-section">
                <h2>Noticias Recientes desde la Web</h2>
                <div id="contenedor-noticias">
                    <p style="text-align:center;">Cargando noticias...</p>
                </div>
            </section>
        </div>
    </main>

    <div id="modal-noticia" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Nueva Noticia</h3>
            <form id="form-noticia">
                <input type="text" id="noticia-titulo" placeholder="T√≠tulo de la noticia" required>
                <textarea id="noticia-contenido" placeholder="Descripci√≥n de la noticia" rows="5" required></textarea>
                <input type="text" id="noticia-imagen" placeholder="URL de la imagen (ej: https://.../foto.jpg)">
                <button type="submit" class="admin-button">Publicar Noticia</button>
            </form>
        </div>
    </div>

    <script src="VerBotonPerfil.js"></script>
    <script src="server.js"></script>
    <script>
        // --- FUNCIONES DEL MODAL ---
        function openModal() { document.getElementById('modal-noticia').style.display = 'block'; }
        function closeModal() { document.getElementById('modal-noticia').style.display = 'none'; }

        document.addEventListener('DOMContentLoaded', async () => {
            const contenedor = document.getElementById('contenedor-noticias');
            const adminPanel = document.getElementById('admin-panel');

            // 1. Verificar si el usuario es Admin para mostrar el panel
            const resUser = await fetch('/api/usuario/perfil');
            const userData = await resUser.json();
            const isAdmin = userData.success; // Si est√° logueado, es admin para este caso

            if (isAdmin) adminPanel.style.display = 'block';

            // 2. Cargar Noticias desde la Base de Datos
            async function cargarNoticias() {
                const res = await fetch('/api/noticias');
                const data = await res.json();
                
                if (data.success) {
                    contenedor.innerHTML = '';
                    data.noticias.forEach(n => {
                        const div = document.createElement('div');
                        div.className = 'noticia-item';
                        div.innerHTML = `
                            ${isAdmin ? `<div class="edit-buttons"><button class="delete-button" onclick="eliminarNoticia(${n.id})">üóëÔ∏è</button></div>` : ''}
                            ${n.imagen_url ? `<img src="${n.imagen_url}" style="width:100%; border-radius:8px; margin-bottom:15px;">` : ''}
                            <h3>${n.titulo}</h3>
                            <p>${n.contenido}</p>
                            <span class="news-date">${new Date(n.fecha_creacion).toLocaleDateString()}</span>
                        `;
                        contenedor.appendChild(div);
                    });
                }
            }

            cargarNoticias();

            // 3. Manejo del Formulario
            document.getElementById('form-noticia').onsubmit = async (e) => {
                e.preventDefault();
                const body = {
                    titulo: document.getElementById('noticia-titulo').value,
                    contenido: document.getElementById('noticia-contenido').value,
                    imagen_url: document.getElementById('noticia-imagen').value
                };

                const res = await fetch('/api/noticias', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    alert("Noticia publicada!");
                    closeModal();
                    location.reload();
                }
            };
        });

        async function eliminarNoticia(id) {
            if(confirm("¬øSeguro que quieres borrar esta noticia?")) {
                await fetch(`/api/noticias/${id}`, { method: 'DELETE' });
                location.reload();
            }
        }
    </script>

    <style>
        /* Estilos r√°pidos para el modal */
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 30px; border-radius: 10px; width: 50%; position: relative; }
        .modal-content input, .modal-content textarea { width: 100%; margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .close { position: absolute; top: 10px; right: 20px; font-size: 30px; cursor: pointer; }
        .news-date { font-size: 0.8em; color: #888; }
    </style>
</body>
</html>